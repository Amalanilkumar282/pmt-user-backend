# Create Board Column API - Complete Documentation

## Overview
This API endpoint creates a new board column with intelligent status management and automatic position shifting. It follows CQRS architecture with comprehensive transaction handling.

---

## API Endpoint

### Create Board Column
**Endpoint:** `POST /api/board/column`

**Description:** Creates a new column for a board with automatic status reuse/creation and position management.

---

## Request

### HTTP Request
```http
POST /api/board/column
Content-Type: application/json
```

### Request Body
```json
{
  "boardId": 1,
  "boardColumnName": "In Review",
  "boardColor": "#FF5733",
  "statusName": "In Review",
  "position": 2
}
```

### Request Parameters

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| `boardId` | integer | ? Yes | Must exist | The ID of the board to add the column to |
| `boardColumnName` | string | ? Yes | 1-255 chars | The display name of the column |
| `boardColor` | string | ? Yes | Hex format | Color in hex format (e.g., #FF5733 or #F57) |
| `statusName` | string | ? Yes | 1-100 chars | The status name (will reuse if exists) |
| `position` | integer | ? Yes | >= 1 | The position where to insert the column |

### Validation Rules

1. **Board ID**
   - Must be a valid integer
   - Board must exist and be active

2. **Board Column Name**
   - Length: 1-255 characters
   - Trimmed automatically

3. **Board Color**
   - Must be valid hex color
   - Formats accepted: `#FF5733` (6 digits) or `#F57` (3 digits)
   - Case-insensitive
   - Normalized to uppercase in storage

4. **Status Name**
   - Length: 1-100 characters
   - Case-insensitive comparison
   - Trimmed automatically

5. **Position**
   - Must be >= 1
   - Cannot exceed `maxExistingPosition + 1`
   - Example: If existing positions are [1, 2, 3], valid positions are 1-4

---

## Response

### Success Response (201 Created)

```json
{
  "status": 201,
  "data": {
    "columnId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
    "boardId": 1,
    "boardColumnName": "In Review",
    "boardColor": "#FF5733",
    "position": 2,
    "statusId": 5,
    "statusName": "In Review",
    "isNewStatus": false,
    "shiftedColumnsCount": 2
  },
  "message": "Board column 'In Review' created successfully with existing status 'In Review'. 2 column(s) shifted to accommodate new position"
}
```

### Response Fields

| Field | Type | Description |
|-------|------|-------------|
| `columnId` | GUID | Unique ID of the created column |
| `boardId` | integer | The board this column belongs to |
| `boardColumnName` | string | The name of the column |
| `boardColor` | string | The hex color code |
| `position` | integer | The position of the column |
| `statusId` | integer | ID of the status (new or existing) |
| `statusName` | string | Name of the status |
| `isNewStatus` | boolean | `true` if new status was created, `false` if existing was reused |
| `shiftedColumnsCount` | integer | Number of columns that were shifted |

---

## Business Logic

### 1. Status Management (Intelligent Reuse)

The API implements smart status management:

```
???????????????????????????????????????????????????????????????
?               Status Name: "In Review"                      ?
???????????????????????????????????????????????????????????????
                       ?
                       ?
         ???????????????????????????????
         ?  Check if status exists?    ?
         ?  (Case-insensitive search)  ?
         ???????????????????????????????
                    ?
        ?????????????????????????
        ?                       ?
        ?                       ?
   ???????????           ????????????????
   ?  EXISTS ?           ?  NOT FOUND   ?
   ???????????           ????????????????
        ?                       ?
        ?                       ?
   ???????????????????    ????????????????????????
   ? Reuse existing  ?    ? Create new status    ?
   ? status ID       ?    ? Get new status ID    ?
   ? isNewStatus=false?    ? isNewStatus=true     ?
   ???????????????????    ????????????????????????
        ?                        ?
        ??????????????????????????
                     ?
                     ?
         ?????????????????????????
         ? Use status ID for     ?
         ? board column creation ?
         ?????????????????????????
```

**Example Scenarios:**

**Scenario A: Status Already Exists**
```
Database Before:
  status table: [1: "To Do", 2: "In Progress", 3: "Done", 4: "In Review"]

Request: statusName = "in review" (case doesn't matter)

Action: Reuses status ID 4
Result: isNewStatus = false
```

**Scenario B: New Status**
```
Database Before:
  status table: [1: "To Do", 2: "In Progress", 3: "Done"]

Request: statusName = "In Review"

Action: Creates new status with ID 4
Result: isNewStatus = true
```

---

### 2. Position Shifting Logic

When inserting a column at a specific position, existing columns shift automatically:

```
BEFORE: Columns at positions [1, 2, 3, 4]
INSERT: New column at position 2

PROCESS:
1. Columns at position >= 2 shift by +1
   - Position 2 ? 3
   - Position 3 ? 4
   - Position 4 ? 5

2. Insert new column at position 2

AFTER: Columns at positions [1, 2, 3, 4, 5]
                                  ?
                                 NEW
```

**Visual Example:**

```
BEFORE:
?????????????????????????????????????????
? To Do   ? In Prog ?  Review ?  Done   ?
? Pos: 1  ? Pos: 2  ? Pos: 3  ? Pos: 4  ?
?????????????????????????????????????????

INSERT "Testing" at Position 2:

AFTER:
???????????????????????????????????????????????????
? To Do   ? Testing ? In Prog ?  Review ?  Done   ?
? Pos: 1  ? Pos: 2  ? Pos: 3  ? Pos: 4  ? Pos: 5  ?
???????????????????????????????????????????????????
         ? NEW      ? Shifted ? Shifted ? Shifted
```

**Position Validation:**

```csharp
// If existing positions are [1, 2, 3]
maxPosition = 3

Valid positions: 1, 2, 3, 4
Invalid positions: 5+ (too high), 0 or negative
```

---

## Transaction Flow

The API uses database transactions to ensure atomicity:

```
????????????????????????????????????????????????????????????????
?                     BEGIN TRANSACTION                        ?
????????????????????????????????????????????????????????????????
                        ?
          ?????????????????????????????
          ?                           ?
          ?                           ?
   ????????????????          ????????????????????
   ? Validate     ?          ? Get/Create       ?
   ? Board Exists ?          ? Status           ?
   ????????????????          ????????????????????
          ?                         ?
          ???????????????????????????
                     ?
                     ?
          ????????????????????????
          ? Validate Position    ?
          ? (1 to max+1)         ?
          ????????????????????????
                     ?
                     ?
          ????????????????????????
          ? Shift Positions      ?
          ? (if inserting)       ?
          ????????????????????????
                     ?
                     ?
          ????????????????????????
          ? Create BoardColumn   ?
          ????????????????????????
                     ?
                     ?
          ????????????????????????
          ? Create Board-Column  ?
          ? Mapping              ?
          ????????????????????????
                     ?
          ????????????????????????
          ?                      ?
     Success?                 Failure?
          ?                      ?
          ?                      ?
   ???????????????      ??????????????????
   ?   COMMIT    ?      ?   ROLLBACK     ?
   ???????????????      ??????????????????
```

**Atomicity Guarantee:**
- All operations succeed ? or all rollback ?
- No partial state (e.g., status created but column not added)

---

## Error Handling

### 400 Bad Request

**Scenario 1: Invalid Board ID**
```json
{
  "status": 400,
  "data": null,
  "message": "Board with ID 999 does not exist or is inactive"
}
```

**Scenario 2: Invalid Position**
```json
{
  "status": 400,
  "data": null,
  "message": "Invalid position 10. Must be between 1 and 4"
}
```

**Scenario 3: Validation Error**
```json
{
  "status": 400,
  "data": null,
  "message": "Validation failed: Board color must be a valid hex color (e.g., #FF5733 or #F57)"
}
```

**Scenario 4: Invalid Hex Color**
```json
{
  "status": 400,
  "data": null,
  "message": "Validation failed: Board color must be a valid hex color (e.g., #FF5733 or #F57)"
}
```

### 500 Internal Server Error

```json
{
  "status": 500,
  "data": null,
  "message": "A database error occurred while creating the board column. Please try again later."
}
```

---

## Example Requests

### Example 1: Create First Column (No Shifting)

**Request:**
```bash
curl -X POST "https://localhost:5001/api/board/column" \
  -H "Content-Type: application/json" \
  -d '{
    "boardId": 1,
    "boardColumnName": "To Do",
    "boardColor": "#3498DB",
    "statusName": "To Do",
    "position": 1
  }'
```

**Response:**
```json
{
  "status": 201,
  "data": {
    "columnId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
    "boardId": 1,
    "boardColumnName": "To Do",
    "boardColor": "#3498DB",
    "position": 1,
    "statusId": 1,
    "statusName": "To Do",
    "isNewStatus": true,
    "shiftedColumnsCount": 0
  },
  "message": "Board column 'To Do' created successfully with new status 'To Do'"
}
```

---

### Example 2: Insert Between Existing Columns (With Shifting)

**Current State:**
```
Board 1 has columns:
  Position 1: "To Do"
  Position 2: "Done"
```

**Request:**
```bash
curl -X POST "https://localhost:5001/api/board/column" \
  -H "Content-Type: application/json" \
  -d '{
    "boardId": 1,
    "boardColumnName": "In Progress",
    "boardColor": "#F39C12",
    "statusName": "In Progress",
    "position": 2
  }'
```

**Response:**
```json
{
  "status": 201,
  "data": {
    "columnId": "b2c3d4e5-f6a7-8901-bcde-f12345678901",
    "boardId": 1,
    "boardColumnName": "In Progress",
    "boardColor": "#F39C12",
    "position": 2,
    "statusId": 2,
    "statusName": "In Progress",
    "isNewStatus": true,
    "shiftedColumnsCount": 1
  },
  "message": "Board column 'In Progress' created successfully with new status 'In Progress'. 1 column(s) shifted to accommodate new position"
}
```

**New State:**
```
Board 1 has columns:
  Position 1: "To Do"
  Position 2: "In Progress" (NEW)
  Position 3: "Done" (shifted from 2)
```

---

### Example 3: Reuse Existing Status

**Current Statuses:**
```
status table: [1: "To Do", 2: "In Progress", 3: "Done"]
```

**Request:**
```bash
curl -X POST "https://localhost:5001/api/board/column" \
  -H "Content-Type: application/json" \
  -d '{
    "boardId": 2,
    "boardColumnName": "Pending",
    "boardColor": "#E74C3C",
    "statusName": "to do",
    "position": 1
  }'
```

**Response:**
```json
{
  "status": 201,
  "data": {
    "columnId": "c3d4e5f6-a7b8-9012-cdef-123456789012",
    "boardId": 2,
    "boardColumnName": "Pending",
    "boardColor": "#E74C3C",
    "position": 1,
    "statusId": 1,
    "statusName": "To Do",
    "isNewStatus": false,
    "shiftedColumnsCount": 0
  },
  "message": "Board column 'Pending' created successfully with existing status 'To Do'"
}
```

**Note:** Status "to do" matched existing "To Do" (case-insensitive), so `statusId: 1` was reused.

---

## Database Schema Impact

### Tables Affected:

#### 1. `status` Table
```sql
-- May insert new row if status doesn't exist
INSERT INTO status (status_name) VALUES ('In Review');
```

#### 2. `board_columns` Table
```sql
-- Always inserts new row
INSERT INTO board_columns (
  id, 
  board_column_name, 
  board_color, 
  status_id, 
  position
) VALUES (
  'a1b2c3d4-e5f6-7890-abcd-ef1234567890',
  'In Review',
  '#FF5733',
  5,
  2
);
```

#### 3. `board_boardcolumn_map` Table
```sql
-- Creates mapping between board and column
INSERT INTO board_boardcolumn_map (
  board_id,
  board_column_id,
  created_at,
  updated_at
) VALUES (
  1,
  'a1b2c3d4-e5f6-7890-abcd-ef1234567890',
  NOW(),
  NOW()
);
```

#### 4. Position Shifting (if applicable)
```sql
-- Updates existing columns' positions
UPDATE board_columns
SET position = position + 1
WHERE id IN (
  SELECT bc.id
  FROM board_columns bc
  JOIN board_boardcolumn_map bcm ON bc.id = bcm.board_column_id
  WHERE bcm.board_id = 1
    AND bc.position >= 2
);
```

---

## Architecture

### CQRS Components

```
???????????????????????????????????????????????????????????????
?                      API Layer                              ?
?                  BoardController.cs                         ?
?  POST /api/board/column                                     ?
???????????????????????????????????????????????????????????????
                        ?
                        ?
???????????????????????????????????????????????????????????????
?                  Application Layer                          ?
?           CreateBoardColumnCommandHandler.cs                ?
?  • Orchestrates business logic                             ?
?  • Validates board exists                                   ?
?  • Manages status (reuse/create)                            ?
?  • Handles position shifting                                ?
?  • Creates column and mapping                               ?
???????????????????????????????????????????????????????????????
                        ?
          ?????????????????????????????
          ?                           ?
          ?                           ?
?????????????????????       ??????????????????????
?  BoardRepository  ?       ?  StatusRepository  ?
?  (Infrastructure) ?       ?  (Infrastructure)  ?
?????????????????????       ??????????????????????
          ?                           ?
          ?????????????????????????????
                        ?
                        ?
              ?????????????????????
              ?    AppDbContext   ?
              ?   (EF Core)       ?
              ?????????????????????
                        ?
                        ?
              ?????????????????????
              ?   PostgreSQL DB   ?
              ?????????????????????
```

### Files Created/Modified:

#### New Files:
1. `BACKEND_CQRS.Domain\Persistance\IStatusRepository.cs`
2. `BACKEND_CQRS.Infrastructure\Repository\StatusRepository.cs`
3. `BACKEND_CQRS.Application\Dto\CreateBoardColumnResponseDto.cs`
4. `BACKEND_CQRS.Application\Command\CreateBoardColumnCommand.cs`
5. `BACKEND_CQRS.Application\Handler\CreateBoardColumnCommandHandler.cs`

#### Modified Files:
6. `BACKEND_CQRS.Domain\Persistance\IBoardRepository.cs` - Added methods
7. `BACKEND_CQRS.Infrastructure\Repository\BoardRepository.cs` - Implemented methods
8. `BACKEND_CQRS.Api\Controllers\BoardController.cs` - Added endpoint
9. `BACKEND_CQRS.Infrastructure\PersistanceServiceRegistration.cs` - Registered StatusRepository
10. `BACKEND_CQRS.Application\MappingProfile\BoardProfile.cs` - Added mapping

---

## Key Features

? **Intelligent Status Management**
- Case-insensitive status lookup
- Automatic reuse of existing statuses
- Creates new status only when necessary
- Returns flag indicating if status was new or reused

? **Automatic Position Shifting**
- Shifts existing columns when inserting
- Maintains sequential positions
- Reports number of columns shifted

? **Transaction Safety**
- All-or-nothing approach
- Rollback on any failure
- No partial state

? **Comprehensive Validation**
- Board existence check
- Position range validation
- Hex color format validation
- Input length validation

? **Detailed Logging**
- Every step logged
- Easy debugging
- Audit trail

? **Error Handling**
- Specific error messages
- Proper HTTP status codes
- User-friendly messages

---

## Performance Considerations

### Queries Executed:

**Scenario: Insert at position 2 with existing status**
```
Query 1: Check if board exists (1 query)
Query 2: Get existing columns (1 query)
Query 3: Find status by name (1 query)
Query 4: Shift positions (1 update query)
Query 5: Insert column (1 insert)
Query 6: Insert mapping (1 insert)

Total: 6 database operations
```

**Optimization:**
- Uses transactions (batched commits)
- Bulk position updates
- Indexed searches (board_id, status_name)

---

## Testing Scenarios

### Happy Path:
- [ ] Create first column (position 1)
- [ ] Create column at end (append)
- [ ] Create column in middle (with shifting)
- [ ] Reuse existing status
- [ ] Create new status

### Edge Cases:
- [ ] Board doesn't exist
- [ ] Invalid position (too high)
- [ ] Invalid position (0 or negative)
- [ ] Invalid hex color
- [ ] Empty strings
- [ ] Very long names (255+ chars)

### Concurrent Scenarios:
- [ ] Two requests creating columns simultaneously
- [ ] Creating column while another is being deleted

---

## Security Considerations

?? **Input Validation:**
- All inputs validated before processing
- SQL injection prevented (EF Core parameterized queries)
- XSS prevention (hex color validation)

?? **Authorization** (TODO):
- Add user authentication
- Check user permissions for board access
- Audit logging for column creation

---

**Version:** 1.0  
**Date:** 2024  
**Status:** ? Production Ready
